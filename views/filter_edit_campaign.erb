<%
err = []
begin
    # map parameters
    gid = params[:gid]
    name = params[:name]
    subject = params[:subject]
    replyto = params[:replyto]
    id_export = params[:id_export]
    body = params[:body]

    # validate: the name is not empty
    err << "Name is required." if name.empty?

    # valdiate: the subject is not empty
    err << "Subject is required." if subject.empty?

    # validate: the replyto is not empty
    err << "Reply-To is required." if replyto.empty?

    # validate: the id_export is not empty
    err << "Export is required." if id_export.empty?

    # validate: the body is not empty
    err << "Body is required." if body.empty?

    # validate: if replyto is not empty, it must be a valid email address
    err << "Reply-To is not a valid email address." if !replyto.empty? && !replyto.email?

    # if any error happened, return to the edition screen
    raise err.join("\n") if err.size > 0

    # load, edit and save the campaign
    o = BlackStack::Emails::Campaign.where(:id=>gid).first
    o.name = name
    o.id_export = id_export
    o.subject = subject
    o.body = body
    o.reply_to = replyto
    o.save

    # return
    redirect "/emails/campaigns/#{o.id.to_guid}/edit?msg="+ CGI::escape('Campaign updated.')
rescue => e
    # return errors
    redirect "/emails/campaigns/#{params[:gid].to_guid}/edit?err="+ CGI::escape(e.message)
end
%>